services:
  openldap_svc:
    # https://hub.docker.com/r/bitnami/openldap
    image: git.lab.lan/lab/openldap_svc:stage
    container_name: openldap_svc
    build:
      extra_hosts: [ "dockerhost:host-gateway" ]
      context: context/openldap
      dockerfile_inline: |
        #FROM git.lab.lan/dockerhub/bitnami_openldap:latest
        FROM bitnami/openldap
    hostname: ldap.lab.lan
    extra_hosts:
    - dockerhost:host-gateway
    - ldap.lab.lan:host-gateway
    restart: unless-stopped
    ports:
    - 389:389
    - 636:636
    environment:
    - LDAP_PORT_NUMBER=389
    - LDAP_ROOT=dc=lab,dc=lan
    # cn=admin,dc=lab,dc=lan
    - LDAP_ADMIN_USERNAME=admin
    - LDAP_ADMIN_PASSWORD=password
    - LDAP_CONFIG_ADMIN_ENABLED=yes
    # cn=config,cn=config
    - LDAP_CONFIG_ADMIN_USERNAME=config
    - LDAP_CONFIG_ADMIN_PASSWORD=password
    - LDAP_USERS=testuser
    - LDAP_PASSWORDS=password
    - LDAP_ENABLE_TLS=yes
    - LDAP_LDAPS_PORT_NUMBER=636
    - LDAP_TLS_CERT_FILE=/opt/bitnami/openldap/certs/ldap-cert.pem
    - LDAP_TLS_KEY_FILE=/opt/bitnami/openldap/certs/ldap-key.pem
    - LDAP_TLS_CA_FILE=/opt/bitnami/openldap/certs/ldap-cert.pem
    volumes:
    - ./data/openldap:/bitnami/openldap
    - ./data/certs:/opt/bitnami/openldap/certs

  client:
    image: client
    container_name: client
    build:
      extra_hosts: [ "dockerhost:host-gateway" ]
      context: context/openldap
      dockerfile_inline: |
        FROM debian:bookworm
        RUN apt-get update
        RUN apt-get install -y sssd libpam-sss libnss-sss oddjob oddjob-mkhomedir ldap-utils sssd-tools libsss-sudo autofs
        RUN apt-get install -y vim iputils-ping nmap net-tools openssh-server rsyslog
        RUN sed -i 's/#Port 22/Port 40022/' /etc/ssh/sshd_config
        RUN mkdir /run/sshd
        RUN useradd -p password ladmin
        COPY sssd.conf /etc/sssd/sssd.conf
        RUN chmod 600 /etc/sssd/sssd.conf
        COPY ldap-cert.pem /usr/local/share/ca-certificates/
        RUN chmod 644 /usr/local/share/ca-certificates/ldap-cert.pem && update-ca-certificates
        COPY ldap.conf /etc/ldap/ldap.conf
        RUN chmod 644 /etc/ldap/ldap.conf
        COPY pamd-sssd-config /etc/pam.d/sssd-config
        COPY entrypoint.sh /entrypoint.sh
        EXPOSE 40022
        USER ladmin

    entrypoint: /entrypoint.sh
    extra_hosts:
      - dockerhost:host-gateway
      - ldap.lab.lan:host-gateway
    ports:
    - 40022:40022
    restart: never
    stdin_open: true
    tty: true


  phpldapadmin_svc:
    image: git.lab.lan/lab/phpldapadmin_svc:stage
    container_name: phpldapadmin1_svc
    build:
      extra_hosts: [ "dockerhost:host-gateway" ]
      context: context/phpldapadmin
      dockerfile_inline: |
        FROM git.lab.lan/dockerhub/alpine:latest
        RUN echo http://dockerhost:8000/alpine > /etc/apk/repositories
        RUN apk add -U --allow-untrusted phpldapadmin caddy php82-fpm s6
        COPY php.ini /etc/php82/
        COPY init.sh /
        COPY Caddyfile /etc/caddy/
        COPY www.conf /etc/php82/php-fpm.d/
        COPY config.php /etc/phpldapadmin/
        RUN mkdir /etc/s6
        COPY s6/ /etc/s6/
        RUN mkdir /www
        WORKDIR /www
        ENTRYPOINT ["/init.sh"]
    extra_hosts:
    - dockerhost:host-gateway
    - ldap.lab.lan:host-gateway
    restart: unless-stopped
    ports:
    - 1380:80
    environment:
    - LDAP_NAME=Lab LDAP
    - LDAP_HOST=ldap.lab.lan
    - LDAP_BASE=dc=lab,dc=lan
    - LDAP_BIND_DN=cn=admin,dc=lab,dc=lan
    - LDAP_BIND_PW=password
    - LDAP_PORT=389
    #- LDAP_TLS=false
