services:
  openldap_svc:
    # https://hub.docker.com/r/bitnami/openldap
    image: git.lab.lan/lab/openldap_svc:stage
    container_name: openldap_svc
    build:
      context: context/openldap
      dockerfile_inline: |
        FROM git.lab.lan/dockerhub/bitnami_openldap:latest
    hostname: ldap.lab.lan
    extra_hosts:
    - dockerhost:host-gateway
    - ldap.lab.lan:192.168.1.6 
    restart: unless-stopped
    ports:
    - 389:389
    - 636:636
    environment:
    - LDAP_PORT_NUMBER=389
    - LDAP_ROOT=dc=lab,dc=lan
    # cn=admin,dc=lab,dc=lan
    - LDAP_ADMIN_USERNAME=admin
    - LDAP_ADMIN_PASSWORD=password
    - LDAP_CONFIG_ADMIN_ENABLED=yes
    # cn=config,cn=config
    - LDAP_CONFIG_ADMIN_USERNAME=config
    - LDAP_CONFIG_ADMIN_PASSWORD=password
    - LDAP_USERS=user
    - LDAP_PASSWORDS=password
    volumes:
    - ./data/openldap:/bitnami/openldap
    - ./data/certs:/opt/bitnami/openldap/certs

  phpldapadmin_svc:
    image: git.lab.lan/lab/phpldapadmin_svc:stage
    container_name: phpldapadmin1_svc
    build:
      context: context/phpldapadmin
      dockerfile_inline: |
        FROM git.lab.lan/dockerhub/alpine:latest
        RUN echo http://dockerhost:8000/alpine > /etc/apk/repositories
        RUN apk add -U --allow-untrusted --no-cache phpldapadmin caddy php82-fpm s6
        COPY php.ini /etc/php82/
        COPY init.sh /
        COPY Caddyfile /etc/caddy/
        COPY www.conf /etc/php82/php-fpm.d/
        COPY config.php /etc/phpldapadmin/
        RUN mkdir /etc/s6
        COPY s6/ /etc/s6/
        RUN mkdir /www
        WORKDIR /www
        ENTRYPOINT ["/init.sh"]
    extra_hosts:
    - dockerhost:host-gateway
    - ldap.lab.lan:192.168.1.6
    restart: unless-stopped
    ports:
    - 1380:80
    environment:
    - LDAP_NAME=Lab LDAP
    - LDAP_HOST=ldap.lab.lan
    - LDAP_BASE=dc=lab,dc=lan
    - LDAP_BIND_DN=cn=admin,dc=lab,dc=lan
    - LDAP_BIND_PW=password
    - LDAP_PORT=389
    #- LDAP_TLS=false
